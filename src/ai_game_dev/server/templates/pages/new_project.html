{% extends "base/layout.html" %}

{% block title %}Create New Project - AI Game Development Portal{% endblock %}

{% block content %}
<!-- Enhanced Project Creation with Real-time Preview -->
<div class="max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Creation Form -->
        <div class="tech-frame rounded-box aspect-[4/5]">
            <div class="safe-box">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                        🚀 Create New Game
                    </h1>
                    <p class="text-lg opacity-90">Describe your vision and watch it come to life</p>
                </div>
                
                <form id="projectForm" class="space-y-4 flex-1">
                    <!-- Game Concept -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Game Concept</span>
                        </label>
                        <textarea 
                            id="description"
                            name="description" 
                            class="textarea textarea-bordered bg-black/30 backdrop-blur-sm border-cyan-500/30 focus:border-cyan-400" 
                            placeholder="A space adventure where you pilot a ship through asteroid fields..."
                            rows="3" 
                            required
                            oninput="updatePreview()">
                        </textarea>
                    </div>
                    
                    <!-- Engine Selection with Visual Cards -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Choose Your Engine</span>
                        </label>
                        <div class="grid grid-cols-3 gap-2 h-20">
                            {% for engine in engines %}
                            <label class="cursor-pointer">
                                <input type="radio" name="engine" value="{{ engine }}" class="hidden" onchange="updatePreview()" {% if selected_engine == engine or (not selected_engine and loop.first) %}checked{% endif %}>
                                <div class="engine-card border-2 border-cyan-500/30 rounded-lg overflow-hidden hover:border-cyan-400 transition-colors">
                                    <img src="/static/assets/engine-panels/{{ engine }}.png" 
                                         alt="{{ engine|title }}" 
                                         class="w-full h-full object-cover">
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Quick Settings -->
                    <div class="grid grid-cols-2 gap-3 mt-8">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-sm">Complexity</span>
                            </label>
                            <select name="complexity" class="select select-sm bg-black/30 border-cyan-500/30" onchange="updatePreview()">
                                <option value="beginner">Beginner</option>
                                <option value="intermediate" selected>Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-sm">Art Style</span>
                            </label>
                            <select name="art_style" class="select select-sm bg-black/30 border-cyan-500/30" onchange="updatePreview()">
                                <option value="pixel">Pixel Art</option>
                                <option value="modern" selected>Modern</option>
                                <option value="minimalist">Minimal</option>
                                <option value="cartoon">Cartoon</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3 mt-8">
                        <button type="button" onclick="togglePreviewModal()" 
                                class="btn btn-outline btn-sm flex-1">
                            👁️ Live Preview
                        </button>
                        <button type="button" onclick="generateProject()" 
                                class="btn custom-button flex-[2] btn-lg" id="generateBtn">
                            🚀 Generate Project
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
    </div>
    
    <!-- Generation Results -->
    <div id="generationResults" class="mt-8 hidden">
        <div class="tech-frame rounded-box">
            <div class="safe-box">
                <div id="resultContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Live Preview Modal -->
<div id="previewModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50" onclick="closePreviewModal(event)">
    <div id="previewModalContent" class="absolute bg-base-200 rounded-lg shadow-2xl border border-cyan-500/30" 
         style="top: 10%; left: 10%; width: 80%; height: 80%; resize: both; overflow: auto;">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-4 border-b border-cyan-500/30 cursor-move" id="previewModalHeader">
            <h2 class="text-xl font-bold text-primary flex items-center gap-2">
                👁️ Live Preview
            </h2>
            <button onclick="closePreviewModal()" class="btn btn-ghost btn-sm btn-circle">
                ✕
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6 h-full overflow-auto">
            <div id="previewContent" class="flex flex-col h-full">
                <!-- Game Preview Image -->
                <div class="bg-black/30 rounded-lg p-6 mb-6 min-h-64 flex items-center justify-center flex-1">
                    <div id="gamePreview" class="text-center">
                        <div class="text-6xl mb-4">🎮</div>
                        <p class="text-lg opacity-80">Start typing to preview your game...</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Engine Specs -->
                    <div id="engineSpecs" class="bg-cyan-900/20 rounded-lg p-4 text-sm">
                        <h3 class="font-bold mb-3 text-cyan-400">Engine Information</h3>
                        <div class="space-y-2">
                            <div>Language: <span class="text-cyan-300" id="engineLang">Python</span></div>
                            <div>Type: <span class="text-cyan-300" id="engineType">2D Framework</span></div>
                            <div>Best For: <span class="text-cyan-300" id="engineBest">Prototypes & 2D Games</span></div>
                        </div>
                    </div>
                    
                    <!-- Project Structure Preview -->
                    <div class="bg-orange-900/20 rounded-lg p-4 text-sm">
                        <h3 class="font-bold mb-3 text-orange-400">Project Structure</h3>
                        <div id="projectStructure" class="font-mono text-xs opacity-80">
                            <div>📁 my_game/</div>
                            <div class="ml-4">📄 main.py</div>
                            <div class="ml-4">📁 assets/</div>
                            <div class="ml-4">📁 src/</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Generation WebSocket -->
<div id="websocketStatus" class="fixed bottom-4 right-4 hidden">
    <div class="alert alert-info">
        <span>🔗 Connected to generation server</span>
    </div>
</div>

<script>
// Engine information database
const engineInfo = {
    pygame: {
        language: 'Python',
        type: '2D Framework',
        bestFor: 'Prototypes & 2D Games',
        structure: [
            '📁 my_game/',
            '  📄 main.py',
            '  📄 game.py',
            '  📁 sprites/',
            '  📁 sounds/',
            '  📄 requirements.txt'
        ]
    },
    bevy: {
        language: 'Rust',
        type: 'ECS Engine',
        bestFor: 'Performance & 3D',
        structure: [
            '📁 my_game/',
            '  📄 Cargo.toml',
            '  📁 src/',
            '    📄 main.rs',
            '    📄 systems.rs',
            '  📁 assets/',
            '  📁 resources/'
        ]
    },
    godot: {
        language: 'GDScript',
        type: 'Scene Engine',
        bestFor: 'Rapid Development',
        structure: [
            '📁 my_game/',
            '  📄 project.godot',
            '  📁 scenes/',
            '  📁 scripts/',
            '  📁 assets/',
            '  📄 Main.tscn'
        ]
    }
};

// Update preview in real-time
function updatePreview() {
    const description = document.getElementById('description').value;
    const selectedEngine = document.querySelector('input[name="engine"]:checked')?.value || 'pygame';
    const complexity = document.querySelector('select[name="complexity"]').value;
    const artStyle = document.querySelector('select[name="art_style"]').value;
    
    // Update engine selection styling
    document.querySelectorAll('.engine-card').forEach(card => {
        card.classList.remove('border-primary', 'bg-primary/10');
    });
    const selectedInput = document.querySelector(`input[value="${selectedEngine}"]`);
    if (selectedInput) {
        const engineCard = selectedInput.closest('.engine-card');
        if (engineCard) {
            engineCard.classList.add('border-primary', 'bg-primary/10');
        }
    }
    
    // Update engine specs
    const info = engineInfo[selectedEngine];
    document.getElementById('engineLang').textContent = info.language;
    document.getElementById('engineType').textContent = info.type;
    document.getElementById('engineBest').textContent = info.bestFor;
    
    // Update project structure
    document.getElementById('projectStructure').innerHTML = info.structure.map(line => 
        `<div style="margin-left: ${(line.match(/\s*/)[0].length * 8)}px">${line.trim()}</div>`
    ).join('');
    
    // Update game preview
    if (description.length > 10) {
        document.getElementById('gamePreview').innerHTML = `
            <div class="text-4xl mb-3">🎮</div>
            <h3 class="font-bold text-lg mb-2">${description.substring(0, 50)}...</h3>
            <div class="text-sm opacity-70">
                ${selectedEngine.toUpperCase()} • ${complexity.toUpperCase()} • ${artStyle.toUpperCase()}
            </div>
            <div class="mt-3 text-primary text-sm">Ready to generate!</div>
        `;
    }
}

// WebSocket connection for real-time updates
let ws = null;

function connectWebSocket() {
    try {
        ws = new WebSocket(`ws://${window.location.host}/ws/generation`);
        
        ws.onopen = function() {
            const statusEl = document.getElementById('websocketStatus');
            if (statusEl) statusEl.classList.remove('hidden');
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'progress') {
                updateGenerationProgress(data.message, data.progress);
            } else if (data.type === 'complete') {
                showGenerationResults(data.result);
            } else if (data.type === 'error') {
                showGenerationError(data.error);
            }
        };
        
        ws.onclose = function() {
            const statusEl = document.getElementById('websocketStatus');
            if (statusEl) statusEl.classList.add('hidden');
        };
    } catch (error) {
        console.log('WebSocket not available, using HTTP fallback');
    }
}

// Generate project with real-time feedback
async function generateProject() {
    const form = document.getElementById('projectForm');
    const formData = new FormData(form);
    const description = formData.get('description');
    
    if (!description || description.length < 10) {
        audioManager.play('error');
        alert('Please provide a more detailed game description');
        return;
    }
    
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.disabled = true;
    generateBtn.innerHTML = '⚡ Generating...';
    
    // Play notification sound
    audioManager.play('notification');
    
    // Show results section
    const resultsSection = document.getElementById('generationResults');
    const resultContent = document.getElementById('resultContent');
    
    if (resultsSection) resultsSection.classList.remove('hidden');
    if (resultContent) resultContent.innerHTML = `
        <div class="text-center py-8">
            <div class="loading loading-spinner loading-lg text-primary mb-4"></div>
            <h3 class="text-xl font-bold mb-2">AI is crafting your game...</h3>
            <p class="opacity-70" id="progressText">Initializing generation process...</p>
            <div class="progress progress-primary w-full mt-4">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>
    `;
    
    try {
        const response = await fetch('/web/generate-project', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.text();
        const resultContent = document.getElementById('resultContent');
        if (resultContent) resultContent.innerHTML = result;
        
        // Play success sound
        audioManager.play('success');
        
    } catch (error) {
        audioManager.play('error');
        const resultContent = document.getElementById('resultContent');
        if (resultContent) {
            resultContent.innerHTML = `
                <div class="alert alert-error">
                    <span>❌ Generation failed: ${error.message}</span>
                </div>
            `;
        }
    } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '🚀 Generate Project';
    }
}

function updateGenerationProgress(message, progress) {
    const progressText = document.getElementById('progressText');
    const progressBar = document.getElementById('progressBar');
    
    if (progressText) progressText.textContent = message;
    if (progressBar) progressBar.style.width = `${progress}%`;
}

function showGenerationResults(result) {
    const resultContent = document.getElementById('resultContent');
    if (!resultContent) return;
    
    resultContent.innerHTML = `
        <div class="text-center py-8">
            <div class="text-6xl mb-4">🎉</div>
            <h3 class="text-2xl font-bold text-primary mb-4">Project Generated Successfully!</h3>
            <div class="stats shadow bg-base-200/30">
                <div class="stat">
                    <div class="stat-title">Files Created</div>
                    <div class="stat-value text-primary">${result.fileCount}</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Engine</div>
                    <div class="stat-value text-secondary">${result.engine}</div>
                </div>
            </div>
            <div class="mt-6">
                <a href="/web/projects/${result.projectId}" class="btn btn-primary btn-lg">
                    View Project →
                </a>
            </div>
        </div>
    `;
}

// Preview Modal Functions
function togglePreviewModal() {
    const modal = document.getElementById('previewModal');
    if (modal.classList.contains('hidden')) {
        modal.classList.remove('hidden');
        updatePreview(); // Refresh preview when opening
        audioManager.play('notification');
    } else {
        closePreviewModal();
    }
}

function closePreviewModal(event) {
    // Only close if clicking the backdrop, not the modal content
    if (!event || event.target.id === 'previewModal') {
        const modal = document.getElementById('previewModal');
        modal.classList.add('hidden');
        audioManager.play('button_click');
    }
}

// Make modal draggable
function makeDraggable() {
    const modal = document.getElementById('previewModalContent');
    const header = document.getElementById('previewModalHeader');
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;

    header.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);

    function dragStart(e) {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;

        if (e.target === header || header.contains(e.target)) {
            isDragging = true;
        }
    }

    function drag(e) {
        if (isDragging) {
            e.preventDefault();
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;

            xOffset = currentX;
            yOffset = currentY;

            modal.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
        }
    }

    function dragEnd(e) {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
    connectWebSocket();
    makeDraggable();
});
</script>

<style>
.engine-card {
    transition: all 0.3s ease;
    height: 100%;
}

.engine-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(100, 255, 218, 0.2);
}

input[name="engine"]:checked + .engine-card {
    border-color: #64ffda !important;
    background-color: rgba(100, 255, 218, 0.1) !important;
    box-shadow: 0 0 20px rgba(100, 255, 218, 0.3) !important;
}

.progress-bar {
    transition: width 0.5s ease;
}
</style>
{% endblock %}