<!-- Feature Flags Configuration Panel -->
<div id="feature-flags-panel" class="glass-panel p-6 mb-6" style="display: none;">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-800">‚öôÔ∏è Feature Flags</h3>
        <button class="btn btn-sm btn-ghost" onclick="toggleFeatureFlagsPanel()">
            <span id="feature-flags-toggle">‚ñº</span>
        </button>
    </div>
    
    <div id="feature-flags-content">
        <p class="text-gray-600 mb-4">Configure your game variants using these feature flags:</p>
        
        <!-- Dynamic feature flags will be populated here -->
        <div id="feature-flags-list" class="space-y-4">
            <!-- Example feature flag -->
            <div class="feature-flag-item border rounded-lg p-4 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold text-gray-800">Grid System</h4>
                        <p class="text-sm text-gray-600">Choose between square or hexagonal tile layout</p>
                    </div>
                    <div class="form-control">
                        <label class="label cursor-pointer">
                            <span class="label-text mr-2">Square</span>
                            <input type="checkbox" class="toggle toggle-primary" checked data-variant="grid_system" data-choice-a="square" data-choice-b="hexagonal">
                            <span class="label-text ml-2">Hexagonal</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="flex justify-end mt-6 space-x-3">
            <button class="btn btn-ghost btn-sm" onclick="resetFeatureFlags()">Reset to Defaults</button>
            <button class="btn btn-primary btn-sm" onclick="applyFeatureFlags()">Apply Changes</button>
            <button class="btn btn-secondary btn-sm" onclick="downloadFeaturesToml()">üìÑ Download features.toml</button>
        </div>
    </div>
</div>

<script>
let featureFlagsExpanded = false;
let currentFeatureFlags = {};

function toggleFeatureFlagsPanel() {
    const panel = document.getElementById('feature-flags-content');
    const toggle = document.getElementById('feature-flags-toggle');
    
    featureFlagsExpanded = !featureFlagsExpanded;
    
    if (featureFlagsExpanded) {
        panel.style.display = 'block';
        toggle.textContent = '‚ñ≤';
    } else {
        panel.style.display = 'none';
        toggle.textContent = '‚ñº';
    }
}

function showFeatureFlagsPanel(variants) {
    if (!variants || variants.length === 0) return;
    
    currentFeatureFlags = {};
    const flagsList = document.getElementById('feature-flags-list');
    flagsList.innerHTML = '';
    
    // Generate feature flag toggles for each variant
    variants.forEach(variant => {
        const flagItem = createFeatureFlagItem(variant);
        flagsList.appendChild(flagItem);
        
        // Set default choice
        currentFeatureFlags[variant.id] = variant.default_choice || variant.choices[0].id;
    });
    
    // Show the panel
    document.getElementById('feature-flags-panel').style.display = 'block';
}

function createFeatureFlagItem(variant) {
    const div = document.createElement('div');
    div.className = 'feature-flag-item border rounded-lg p-4 bg-gray-50';
    
    const choiceA = variant.choices[0];
    const choiceB = variant.choices[1];
    
    div.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <h4 class="font-semibold text-gray-800">${variant.name}</h4>
                <p class="text-sm text-gray-600">${variant.description}</p>
                ${variant.educational_value ? `
                    <div class="text-xs text-purple-600 mt-1">
                        üìö Learning: ${variant.educational_value}
                    </div>
                ` : ''}
            </div>
            <div class="form-control">
                <label class="label cursor-pointer">
                    <span class="label-text mr-2 text-sm">${choiceA.name}</span>
                    <input 
                        type="checkbox" 
                        class="toggle toggle-primary" 
                        ${variant.default_choice === choiceA.id ? 'checked' : ''}
                        onchange="updateFeatureFlag('${variant.id}', this.checked ? '${choiceB.id}' : '${choiceA.id}')"
                        data-variant="${variant.id}"
                        data-choice-a="${choiceA.id}" 
                        data-choice-b="${choiceB.id}">
                    <span class="label-text ml-2 text-sm">${choiceB.name}</span>
                </label>
            </div>
        </div>
        
        <!-- Choice descriptions -->
        <div class="mt-3 grid grid-cols-2 gap-3 text-xs">
            <div class="bg-green-50 p-2 rounded">
                <div class="font-medium text-green-700">${choiceA.name}</div>
                <div class="text-green-600">${choiceA.description}</div>
                <div class="text-green-500 mt-1">Difficulty: ${choiceA.difficulty || 'Same'}</div>
            </div>
            <div class="bg-orange-50 p-2 rounded">
                <div class="font-medium text-orange-700">${choiceB.name}</div>
                <div class="text-orange-600">${choiceB.description}</div>
                <div class="text-orange-500 mt-1">Difficulty: ${choiceB.difficulty || 'Same'}</div>
            </div>
        </div>
    `;
    
    return div;
}

function updateFeatureFlag(variantId, choiceId) {
    currentFeatureFlags[variantId] = choiceId;
    console.log('Updated feature flag:', variantId, '‚Üí', choiceId);
}

function resetFeatureFlags() {
    // Reset all toggles to default positions
    const toggles = document.querySelectorAll('[data-variant]');
    toggles.forEach(toggle => {
        const variantId = toggle.dataset.variant;
        const choiceA = toggle.dataset.choiceA;
        
        toggle.checked = false; // Default to choice A
        updateFeatureFlag(variantId, choiceA);
    });
    
    showNotification('üîÑ Feature flags reset to defaults', 'info');
}

function applyFeatureFlags() {
    // Send the current feature flags to the backend to regenerate the game
    fetch('/api/apply-feature-flags', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            feature_flags: currentFeatureFlags
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ Feature flags applied! Game updated.', 'success');
            // Optionally reload the generation result
            if (data.updated_code) {
                updateGenerationResult(data);
            }
        } else {
            showNotification('‚ùå Failed to apply feature flags', 'error');
        }
    })
    .catch(error => {
        console.error('Error applying feature flags:', error);
        showNotification('‚ùå Error applying feature flags', 'error');
    });
}

function downloadFeaturesToml() {
    // Generate and download features.toml file
    const tomlContent = generateFeaturesToml(currentFeatureFlags);
    
    const blob = new Blob([tomlContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'features.toml';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    URL.revokeObjectURL(url);
    
    showNotification('üìÑ features.toml downloaded!', 'success');
}

function generateFeaturesToml(flags) {
    let toml = `# Game Feature Flags Configuration
# Toggle different implementation variants for your game

[features]
description = "Feature flags for game variants - toggle A/B implementations"

[features.variants]
`;
    
    Object.entries(flags).forEach(([variantId, choiceId]) => {
        toml += `${variantId} = "${choiceId}"\n`;
    });
    
    toml += `
# How to use:
# 1. Change the values above to switch between A/B implementations
# 2. Reload your game to see the changes
# 3. Experiment with different combinations!
`;
    
    return toml;
}

function updateGenerationResult(data) {
    // Update the generation result display with new code
    const resultDiv = document.getElementById('generation-result');
    if (resultDiv && data.updated_code) {
        // This would update the displayed code with the new variant choices
        console.log('Updating generation result with new variants');
    }
}
</script>