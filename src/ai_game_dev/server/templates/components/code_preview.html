<!-- Code Preview and Editing Component -->
<div id="code-preview-modal" class="modal">
    <div class="modal-box w-11/12 max-w-7xl bg-base-100/95 backdrop-blur-sm">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button>
        </form>
        
        <h3 class="font-bold text-lg mb-4">
            <span class="text-primary">üíª</span> Code Preview & Editor
        </h3>
        
        <!-- File Tree and Code Editor Layout -->
        <div class="flex gap-4 h-96">
            <!-- File Tree -->
            <div class="w-1/4 bg-base-200/50 rounded p-3 overflow-y-auto">
                <h4 class="font-semibold mb-3">üìÅ Project Files</h4>
                <div id="file-tree" class="space-y-1">
                    <!-- File tree will be populated dynamically -->
                </div>
            </div>
            
            <!-- Code Editor -->
            <div class="flex-1 bg-base-200/50 rounded">
                <div class="flex justify-between items-center p-3 border-b border-base-300">
                    <div class="flex items-center gap-2">
                        <span id="current-file-icon">üìÑ</span>
                        <span id="current-file-name" class="font-mono text-sm">Select a file</span>
                        <div id="file-status" class="badge badge-ghost badge-sm hidden">Modified</div>
                    </div>
                    <div class="flex gap-2">
                        <button id="save-file" class="btn btn-xs btn-primary" disabled>
                            üíæ Save
                        </button>
                        <button id="download-file" class="btn btn-xs btn-outline" disabled>
                            üì• Download
                        </button>
                        <button id="format-code" class="btn btn-xs btn-secondary" disabled>
                            ‚ú® Format
                        </button>
                    </div>
                </div>
                
                <div class="p-3">
                    <textarea 
                        id="code-editor" 
                        class="textarea textarea-bordered w-full h-72 font-mono text-sm resize-none"
                        placeholder="Select a file to view its contents..."
                        disabled
                    ></textarea>
                </div>
            </div>
        </div>
        
        <!-- Editor Controls -->
        <div class="flex justify-between items-center mt-4">
            <div class="flex gap-2">
                <div class="badge badge-outline">
                    Lines: <span id="line-count">0</span>
                </div>
                <div class="badge badge-outline">
                    Size: <span id="file-size">0 B</span>
                </div>
                <div class="badge badge-outline">
                    Language: <span id="file-language">-</span>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button id="add-new-file" class="btn btn-sm btn-success">
                    ‚ûï New File
                </button>
                <button id="delete-file" class="btn btn-sm btn-error" disabled>
                    üóëÔ∏è Delete
                </button>
                <button id="export-project" class="btn btn-sm btn-primary">
                    üì¶ Export Project
                </button>
            </div>
        </div>
        
        <!-- Syntax Highlighting and Validation -->
        <div id="code-issues" class="mt-4 hidden">
            <h5 class="font-semibold mb-2">‚ö†Ô∏è Code Issues</h5>
            <div id="issues-list" class="space-y-1 max-h-32 overflow-y-auto">
                <!-- Issues will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- New File Modal -->
<dialog id="new-file-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Create New File</h3>
        <form id="new-file-form" class="space-y-4 mt-4">
            <div class="form-control">
                <label class="label">
                    <span class="label-text">File Name</span>
                </label>
                <input type="text" id="new-file-name" class="input input-bordered" placeholder="example.py">
            </div>
            <div class="form-control">
                <label class="label">
                    <span class="label-text">File Type</span>
                </label>
                <select id="new-file-type" class="select select-bordered">
                    <option value="python">Python (.py)</option>
                    <option value="javascript">JavaScript (.js)</option>
                    <option value="html">HTML (.html)</option>
                    <option value="css">CSS (.css)</option>
                    <option value="json">JSON (.json)</option>
                    <option value="md">Markdown (.md)</option>
                    <option value="txt">Text (.txt)</option>
                </select>
            </div>
            <div class="modal-action">
                <button type="button" class="btn" onclick="document.getElementById('new-file-modal').close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</dialog>

<script>
class CodePreviewEditor {
    constructor() {
        this.currentProject = null;
        this.currentFile = null;
        this.files = {};
        this.unsavedChanges = new Set();
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        // Editor events
        document.getElementById('code-editor').addEventListener('input', () => {
            this.onCodeChange();
        });
        
        // Button events
        document.getElementById('save-file').addEventListener('click', () => {
            this.saveCurrentFile();
        });
        
        document.getElementById('download-file').addEventListener('click', () => {
            this.downloadCurrentFile();
        });
        
        document.getElementById('format-code').addEventListener('click', () => {
            this.formatCode();
        });
        
        document.getElementById('add-new-file').addEventListener('click', () => {
            this.showNewFileDialog();
        });
        
        document.getElementById('delete-file').addEventListener('click', () => {
            this.deleteCurrentFile();
        });
        
        document.getElementById('export-project').addEventListener('click', () => {
            this.exportProject();
        });
        
        // New file form
        document.getElementById('new-file-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.createNewFile();
        });
    }
    
    async loadProject(projectId) {
        try {
            const response = await fetch(`/api/projects/${projectId}`);
            const project = await response.json();
            
            this.currentProject = project;
            this.files = project.generated_files || {};
            this.unsavedChanges.clear();
            
            this.renderFileTree();
            
            // Open the modal
            document.getElementById('code-preview-modal').showModal();
            
        } catch (error) {
            console.error('Failed to load project:', error);
            alert('Failed to load project files');
        }
    }
    
    renderFileTree() {
        const fileTree = document.getElementById('file-tree');
        fileTree.innerHTML = '';
        
        const sortedFiles = Object.keys(this.files).sort();
        
        for (const filename of sortedFiles) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item p-2 rounded cursor-pointer hover:bg-base-300 transition-colors';
            
            const icon = this.getFileIcon(filename);
            const hasChanges = this.unsavedChanges.has(filename);
            
            fileItem.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="flex items-center gap-2">
                        <span class="text-sm">${icon}</span>
                        <span class="font-mono text-xs ${hasChanges ? 'text-warning' : ''}">${filename}</span>
                    </span>
                    ${hasChanges ? '<span class="w-2 h-2 bg-warning rounded-full"></span>' : ''}
                </div>
            `;
            
            fileItem.addEventListener('click', () => {
                this.selectFile(filename);
            });
            
            fileTree.appendChild(fileItem);
        }
    }
    
    getFileIcon(filename) {
        const ext = filename.split('.').pop()?.toLowerCase();
        const icons = {
            'py': 'üêç',
            'js': 'üìú',
            'html': 'üåê',
            'css': 'üé®',
            'json': 'üìã',
            'md': 'üìù',
            'txt': 'üìÑ',
            'toml': '‚öôÔ∏è',
            'yaml': 'üìä',
            'yml': 'üìä'
        };
        return icons[ext] || 'üìÑ';
    }
    
    selectFile(filename) {
        // Save current file if needed
        if (this.currentFile && this.hasUnsavedChanges()) {
            this.saveCurrentChanges();
        }
        
        this.currentFile = filename;
        const content = this.files[filename] || '';
        
        // Update UI
        document.getElementById('current-file-icon').textContent = this.getFileIcon(filename);
        document.getElementById('current-file-name').textContent = filename;
        document.getElementById('code-editor').value = content;
        document.getElementById('code-editor').disabled = false;
        
        // Update file info
        document.getElementById('line-count').textContent = content.split('\n').length;
        document.getElementById('file-size').textContent = this.formatFileSize(content.length);
        document.getElementById('file-language').textContent = this.getLanguage(filename);
        
        // Enable buttons
        document.getElementById('save-file').disabled = false;
        document.getElementById('download-file').disabled = false;
        document.getElementById('format-code').disabled = false;
        document.getElementById('delete-file').disabled = false;
        
        // Update file tree selection
        this.updateFileTreeSelection(filename);
        
        // Validate code
        this.validateCode(content, filename);
    }
    
    updateFileTreeSelection(selectedFilename) {
        const fileItems = document.querySelectorAll('.file-item');
        fileItems.forEach(item => {
            item.classList.remove('bg-primary', 'text-primary-content');
            if (item.textContent.includes(selectedFilename)) {
                item.classList.add('bg-primary', 'text-primary-content');
            }
        });
    }
    
    onCodeChange() {
        if (!this.currentFile) return;
        
        const newContent = document.getElementById('code-editor').value;
        this.files[this.currentFile] = newContent;
        this.unsavedChanges.add(this.currentFile);
        
        // Update UI indicators
        document.getElementById('file-status').classList.remove('hidden');
        document.getElementById('line-count').textContent = newContent.split('\n').length;
        document.getElementById('file-size').textContent = this.formatFileSize(newContent.length);
        
        // Update file tree
        this.renderFileTree();
        
        // Validate code
        this.validateCode(newContent, this.currentFile);
    }
    
    hasUnsavedChanges() {
        const currentContent = document.getElementById('code-editor').value;
        return currentContent !== (this.files[this.currentFile] || '');
    }
    
    saveCurrentChanges() {
        if (this.currentFile) {
            const content = document.getElementById('code-editor').value;
            this.files[this.currentFile] = content;
        }
    }
    
    async saveCurrentFile() {
        if (!this.currentFile || !this.currentProject) return;
        
        try {
            const content = document.getElementById('code-editor').value;
            
            // Update local state
            this.files[this.currentFile] = content;
            this.unsavedChanges.delete(this.currentFile);
            
            // Save to server (if API exists)
            const response = await fetch(`/api/projects/${this.currentProject.id}/files/${this.currentFile}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            });
            
            if (response.ok) {
                document.getElementById('file-status').classList.add('hidden');
                this.renderFileTree();
                this.showToast('File saved successfully', 'success');
            } else {
                this.showToast('Failed to save file', 'error');
            }
            
        } catch (error) {
            console.error('Save failed:', error);
            this.showToast('Save failed: ' + error.message, 'error');
        }
    }
    
    downloadCurrentFile() {
        if (!this.currentFile) return;
        
        const content = document.getElementById('code-editor').value;
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = this.currentFile;
        a.click();
        
        URL.revokeObjectURL(url);
    }
    
    formatCode() {
        if (!this.currentFile) return;
        
        const content = document.getElementById('code-editor').value;
        const language = this.getLanguage(this.currentFile);
        
        // Basic formatting for common languages
        let formatted = content;
        
        if (language === 'Python') {
            // Basic Python formatting (in a real implementation, use a proper formatter)
            formatted = this.formatPython(content);
        } else if (language === 'JavaScript') {
            formatted = this.formatJavaScript(content);
        }
        
        document.getElementById('code-editor').value = formatted;
        this.onCodeChange();
    }
    
    formatPython(code) {
        // Very basic Python formatting
        return code.split('\n').map(line => {
            line = line.trim();
            if (line.startsWith('def ') || line.startsWith('class ') || line.startsWith('if ') || 
                line.startsWith('for ') || line.startsWith('while ') || line.startsWith('with ') ||
                line.startsWith('try:') || line.startsWith('except') || line.startsWith('finally:')) {
                return line;
            }
            if (line && !line.startsWith('#')) {
                return '    ' + line; // Basic indentation
            }
            return line;
        }).join('\n');
    }
    
    formatJavaScript(code) {
        // Very basic JS formatting
        return code.replace(/;/g, ';\n').replace(/{/g, '{\n').replace(/}/g, '\n}');
    }
    
    showNewFileDialog() {
        document.getElementById('new-file-modal').showModal();
    }
    
    createNewFile() {
        const name = document.getElementById('new-file-name').value.trim();
        const type = document.getElementById('new-file-type').value;
        
        if (!name) {
            alert('Please enter a file name');
            return;
        }
        
        // Add extension if not present
        let filename = name;
        const extensions = {
            'python': '.py',
            'javascript': '.js',
            'html': '.html',
            'css': '.css',
            'json': '.json',
            'md': '.md',
            'txt': '.txt'
        };
        
        if (!filename.includes('.')) {
            filename += extensions[type] || '.txt';
        }
        
        // Check if file already exists
        if (this.files[filename]) {
            alert('A file with this name already exists');
            return;
        }
        
        // Create file with template content
        const templates = {
            'python': '# New Python file\n\ndef main():\n    pass\n\nif __name__ == "__main__":\n    main()\n',
            'javascript': '// New JavaScript file\n\nfunction main() {\n    // Your code here\n}\n\nmain();\n',
            'html': '<!DOCTYPE html>\n<html>\n<head>\n    <title>New HTML File</title>\n</head>\n<body>\n    <h1>Hello World</h1>\n</body>\n</html>\n',
            'css': '/* New CSS file */\n\nbody {\n    margin: 0;\n    padding: 0;\n    font-family: Arial, sans-serif;\n}\n',
            'json': '{\n    "name": "new-file",\n    "version": "1.0.0"\n}\n',
            'md': '# New Markdown File\n\nYour content here.\n'
        };
        
        this.files[filename] = templates[type] || '';
        this.renderFileTree();
        this.selectFile(filename);
        
        // Close modal
        document.getElementById('new-file-modal').close();
        
        // Clear form
        document.getElementById('new-file-name').value = '';
        document.getElementById('new-file-type').value = 'python';
    }
    
    deleteCurrentFile() {
        if (!this.currentFile) return;
        
        if (confirm(`Are you sure you want to delete ${this.currentFile}?`)) {
            delete this.files[this.currentFile];
            this.unsavedChanges.delete(this.currentFile);
            
            // Clear editor
            document.getElementById('code-editor').value = '';
            document.getElementById('code-editor').disabled = true;
            document.getElementById('current-file-name').textContent = 'Select a file';
            
            // Disable buttons
            document.getElementById('save-file').disabled = true;
            document.getElementById('download-file').disabled = true;
            document.getElementById('format-code').disabled = true;
            document.getElementById('delete-file').disabled = true;
            
            this.currentFile = null;
            this.renderFileTree();
        }
    }
    
    async exportProject() {
        if (!this.currentProject) return;
        
        try {
            const response = await fetch(`/api/projects/${this.currentProject.id}/export`);
            const blob = await response.blob();
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${this.currentProject.name.replace(/\s+/g, '_')}.zip`;
            a.click();
            
            URL.revokeObjectURL(url);
            
        } catch (error) {
            console.error('Export failed:', error);
            alert('Failed to export project');
        }
    }
    
    validateCode(content, filename) {
        const language = this.getLanguage(filename);
        const issues = [];
        
        // Basic validation for common issues
        if (language === 'Python') {
            issues.push(...this.validatePython(content));
        } else if (language === 'JavaScript') {
            issues.push(...this.validateJavaScript(content));
        }
        
        this.displayIssues(issues);
    }
    
    validatePython(code) {
        const issues = [];
        const lines = code.split('\n');
        
        lines.forEach((line, index) => {
            const lineNum = index + 1;
            
            // Check for common Python issues
            if (line.trim().endsWith(':') && !line.trim().match(/^(def|class|if|for|while|try|except|finally|with|else|elif)/)) {
                issues.push({
                    line: lineNum,
                    type: 'warning',
                    message: 'Unusual colon usage'
                });
            }
            
            if (line.includes('print(') && !line.includes('print()')) {
                // This is actually fine, but as an example
            }
        });
        
        return issues;
    }
    
    validateJavaScript(code) {
        const issues = [];
        
        // Basic JS validation
        if (code.includes('var ')) {
            issues.push({
                line: 0,
                type: 'suggestion',
                message: 'Consider using let or const instead of var'
            });
        }
        
        return issues;
    }
    
    displayIssues(issues) {
        const issuesContainer = document.getElementById('code-issues');
        const issuesList = document.getElementById('issues-list');
        
        if (issues.length === 0) {
            issuesContainer.classList.add('hidden');
            return;
        }
        
        issuesContainer.classList.remove('hidden');
        issuesList.innerHTML = '';
        
        issues.forEach(issue => {
            const issueItem = document.createElement('div');
            issueItem.className = `alert alert-${issue.type === 'error' ? 'error' : issue.type === 'warning' ? 'warning' : 'info'} py-1 px-2`;
            issueItem.innerHTML = `
                <span class="text-xs">
                    Line ${issue.line}: ${issue.message}
                </span>
            `;
            issuesList.appendChild(issueItem);
        });
    }
    
    getLanguage(filename) {
        const ext = filename.split('.').pop()?.toLowerCase();
        const languages = {
            'py': 'Python',
            'js': 'JavaScript',
            'html': 'HTML',
            'css': 'CSS',
            'json': 'JSON',
            'md': 'Markdown',
            'txt': 'Text',
            'toml': 'TOML',
            'yaml': 'YAML',
            'yml': 'YAML'
        };
        return languages[ext] || 'Text';
    }
    
    formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    showToast(message, type = 'info') {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.className = `toast toast-top toast-end`;
        toast.innerHTML = `
            <div class="alert alert-${type}">
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
}

// Global instance
window.codePreviewEditor = new CodePreviewEditor();

// Function to open code preview for a project
function openCodePreview(projectId) {
    window.codePreviewEditor.loadProject(projectId);
}
</script>