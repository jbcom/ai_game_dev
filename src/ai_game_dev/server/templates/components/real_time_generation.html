<!-- Real-time generation progress component -->
<div id="real-time-generation" class="hidden">
    <div class="card bg-base-100/20 backdrop-blur-sm shadow-xl glow">
        <div class="card-body">
            <h3 class="card-title text-lg mb-4">
                <img src="/static/assets/logos/main-logo.png" alt="Generating" class="w-8 h-8 animate-pulse">
                Real-time Generation Progress
            </h3>
            
            <!-- Progress Steps -->
            <div class="steps steps-vertical lg:steps-horizontal mb-6">
                <div id="step-1" class="step step-primary">
                    <span class="step-title">Analyzing Description</span>
                </div>
                <div id="step-2" class="step">
                    <span class="step-title">Planning Architecture</span>
                </div>
                <div id="step-3" class="step">
                    <span class="step-title">Generating Code</span>
                </div>
                <div id="step-4" class="step">
                    <span class="step-title">Creating Assets</span>
                </div>
                <div id="step-5" class="step">
                    <span class="step-title">Finalizing Project</span>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mb-4">
                <div class="flex justify-between text-sm mb-2">
                    <span>Overall Progress</span>
                    <span id="progress-percentage">0%</span>
                </div>
                <div class="w-full bg-base-300 rounded-full h-3 overflow-hidden">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-primary to-secondary transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Current Activity -->
            <div class="alert alert-info bg-base-200/50">
                <div class="flex items-center gap-3">
                    <span class="loading loading-spinner loading-sm"></span>
                    <div>
                        <div class="font-bold">Current Activity</div>
                        <div id="current-activity" class="text-sm">Initializing generation process...</div>
                    </div>
                </div>
            </div>
            
            <!-- Live Log -->
            <div class="collapse collapse-arrow bg-base-200/30 mt-4">
                <input type="checkbox" id="log-toggle">
                <div class="collapse-title text-sm font-medium">
                    ðŸ“‹ Generation Log
                </div>
                <div class="collapse-content">
                    <div id="generation-log" class="bg-base-300/50 p-3 rounded text-xs font-mono max-h-64 overflow-y-auto">
                        <div class="text-success">[00:00] Starting AI game generation...</div>
                    </div>
                </div>
            </div>
            
            <!-- Files Generated Counter -->
            <div class="stats stats-horizontal shadow mt-4">
                <div class="stat place-items-center py-2">
                    <div class="stat-title text-xs">Files Generated</div>
                    <div id="files-count" class="stat-value text-primary text-lg">0</div>
                </div>
                <div class="stat place-items-center py-2">
                    <div class="stat-title text-xs">Lines of Code</div>
                    <div id="lines-count" class="stat-value text-secondary text-lg">0</div>
                </div>
                <div class="stat place-items-center py-2">
                    <div class="stat-title text-xs">Assets Created</div>
                    <div id="assets-count" class="stat-value text-accent text-lg">0</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class RealTimeGenerationTracker {
    constructor() {
        this.ws = null;
        this.projectId = null;
        this.startTime = null;
        this.steps = [
            "Analyzing Description",
            "Planning Architecture", 
            "Generating Code",
            "Creating Assets",
            "Finalizing Project"
        ];
        this.currentStep = 0;
    }
    
    connect(projectId) {
        this.projectId = projectId;
        this.startTime = Date.now();
        
        // Show the real-time component
        document.getElementById('real-time-generation').classList.remove('hidden');
        
        // Connect to WebSocket
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        this.ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
        
        this.ws.onopen = () => {
            this.log('Connected to real-time updates');
            this.ws.send(JSON.stringify({
                type: 'subscribe_project',
                project_id: projectId
            }));
        };
        
        this.ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.handleMessage(data);
        };
        
        this.ws.onclose = () => {
            this.log('Disconnected from real-time updates');
        };
        
        this.ws.onerror = (error) => {
            this.log(`Connection error: ${error.message}`);
        };
    }
    
    handleMessage(data) {
        switch (data.type) {
            case 'generation_progress':
                this.updateProgress(data.progress);
                break;
            case 'generation_complete':
                this.onComplete(data.result);
                break;
            case 'generation_error':
                this.onError(data.error);
                break;
            case 'subscription_confirmed':
                this.log(`Subscribed to project ${data.project_id}`);
                break;
        }
    }
    
    updateProgress(progress) {
        // Update progress bar
        const percentage = Math.round(progress.percentage || 0);
        document.getElementById('progress-percentage').textContent = `${percentage}%`;
        document.getElementById('progress-bar').style.width = `${percentage}%`;
        
        // Update current activity
        if (progress.activity) {
            document.getElementById('current-activity').textContent = progress.activity;
        }
        
        // Update step indicator
        if (progress.step !== undefined) {
            this.updateStep(progress.step);
        }
        
        // Update counters
        if (progress.files_count !== undefined) {
            document.getElementById('files-count').textContent = progress.files_count;
        }
        if (progress.lines_count !== undefined) {
            document.getElementById('lines-count').textContent = progress.lines_count;
        }
        if (progress.assets_count !== undefined) {
            document.getElementById('assets-count').textContent = progress.assets_count;
        }
        
        // Log the progress
        if (progress.message) {
            this.log(progress.message);
        }
    }
    
    updateStep(stepIndex) {
        // Reset all steps
        for (let i = 1; i <= this.steps.length; i++) {
            const stepEl = document.getElementById(`step-${i}`);
            stepEl.classList.remove('step-primary', 'step-success');
        }
        
        // Mark completed steps
        for (let i = 1; i <= stepIndex; i++) {
            const stepEl = document.getElementById(`step-${i}`);
            stepEl.classList.add('step-success');
        }
        
        // Mark current step
        if (stepIndex < this.steps.length) {
            const currentStepEl = document.getElementById(`step-${stepIndex + 1}`);
            currentStepEl.classList.add('step-primary');
        }
        
        this.currentStep = stepIndex;
    }
    
    onComplete(result) {
        // Mark all steps as complete
        this.updateStep(this.steps.length);
        
        // Update progress to 100%
        document.getElementById('progress-percentage').textContent = '100%';
        document.getElementById('progress-bar').style.width = '100%';
        
        // Update activity
        document.getElementById('current-activity').textContent = 'Generation completed successfully!';
        
        // Log completion
        const duration = Math.round((Date.now() - this.startTime) / 1000);
        this.log(`Generation completed in ${duration} seconds`);
        this.log(`Generated ${result.files_count || 0} files with ${result.lines_count || 0} lines of code`);
        
        // Close WebSocket
        if (this.ws) {
            this.ws.close();
        }
        
        // Auto-hide after a delay
        setTimeout(() => {
            this.hide();
        }, 5000);
    }
    
    onError(error) {
        // Update activity to show error
        document.getElementById('current-activity').textContent = `Error: ${error}`;
        
        // Log error
        this.log(`Generation failed: ${error}`, 'error');
        
        // Close WebSocket
        if (this.ws) {
            this.ws.close();
        }
    }
    
    log(message, type = 'info') {
        const logContainer = document.getElementById('generation-log');
        const timestamp = new Date().toLocaleTimeString();
        const colorClass = type === 'error' ? 'text-error' : type === 'success' ? 'text-success' : 'text-info';
        
        const logEntry = document.createElement('div');
        logEntry.className = colorClass;
        logEntry.textContent = `[${timestamp}] ${message}`;
        
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    hide() {
        document.getElementById('real-time-generation').classList.add('hidden');
    }
    
    disconnect() {
        if (this.ws) {
            this.ws.close();
        }
        this.hide();
    }
}

// Global instance
window.generationTracker = new RealTimeGenerationTracker();
</script>